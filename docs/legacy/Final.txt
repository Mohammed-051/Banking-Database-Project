CREATE TABLE Bank (
    Code VARCHAR2(10) PRIMARY KEY,
    B_name VARCHAR2(100) NOT NULL,
    City VARCHAR2(50) NOT NULL,
    Address VARCHAR2(200)
);
CREATE TABLE Branch (
    Branch_Code VARCHAR2(10) PRIMARY KEY,
    Branch_name VARCHAR2(100) NOT NULL,
    Address VARCHAR2(200),
    Head_Office VARCHAR2(100),
    Branch_Details VARCHAR2(200),
    City_Name VARCHAR2(50),
    Bank_Code VARCHAR2(10),
    CONSTRAINT fk_branch_bank FOREIGN KEY (Bank_Code) REFERENCES Bank(Code)
);

CREATE TABLE Customer (
    Cust_Id VARCHAR2(10) PRIMARY KEY,
    First_Name VARCHAR2(50),
    Last_Name VARCHAR2(50),
    Name VARCHAR2(100),
    Birth_Date DATE,
    Street_Number VARCHAR2(20),
    Street_Name VARCHAR2(100),
    Unit VARCHAR2(20),
    City VARCHAR2(50),
    State VARCHAR2(30),
    Zip_Code VARCHAR2(10),
    Email_Id VARCHAR2(100),
    Social_Security_Number VARCHAR2(20),
    Address VARCHAR2(200),
    Branch_Code VARCHAR2(10),
    CONSTRAINT fk_customer_branch FOREIGN KEY (Branch_Code) REFERENCES Branch(Branch_Code)
);

CREATE TABLE Customer_Phone (
    Phone_Number VARCHAR2(20),
    Customer_Id VARCHAR2(10),
    Phone_Type VARCHAR2(20),
    PRIMARY KEY (Phone_Number, Customer_Id),
    CONSTRAINT fk_cusphone_customer FOREIGN KEY (Customer_Id) REFERENCES Customer(Cust_Id)
);

CREATE TABLE Employee (
    Emp_Id VARCHAR2(10) PRIMARY KEY,
    Emp_name VARCHAR2(100) NOT NULL,
    Mobile_no VARCHAR2(20),
    Address VARCHAR2(200)
);

CREATE TABLE Account (
    Account_No VARCHAR2(15) PRIMARY KEY,
    Account_Balance NUMBER(15,2) NOT NULL,
    Account_Type VARCHAR2(20),
    Account_Type_Description VARCHAR2(200),
    Customer_Id VARCHAR2(10),
    CONSTRAINT fk_account_customer FOREIGN KEY (Customer_Id) REFERENCES Customer(Cust_Id)
);

CREATE TABLE Saving (
    Account_No VARCHAR2(15) PRIMARY KEY,
    Interest_Rate NUMBER(5,2),
    CONSTRAINT fk_saving_account FOREIGN KEY (Account_No) REFERENCES Account(Account_No)
);

CREATE TABLE Current (
    Account_No VARCHAR2(15) PRIMARY KEY,
    Overdraft_Limit NUMBER(12,2),
    CONSTRAINT fk_current_account FOREIGN KEY (Account_No) REFERENCES Account(Account_No)
);

CREATE TABLE Account_Management (
    Account_No VARCHAR2(15),
    Emp_Id VARCHAR2(10),
    Management_Date DATE,
    PRIMARY KEY (Account_No, Emp_Id),
    CONSTRAINT fk_mngmt_account FOREIGN KEY (Account_No) REFERENCES Account(Account_No),
    CONSTRAINT fk_mngmt_employee FOREIGN KEY (Emp_Id) REFERENCES Employee(Emp_Id)
);

CREATE TABLE Credit_Card (
    Credit_Card_Number VARCHAR2(20) PRIMARY KEY,
    Credit_Limit NUMBER(12,2),
    Amount_Spent NUMBER(12,2),
    Bill_Payment_Due_Date DATE,
    Minimum_Payment NUMBER(12,2),
    Customer_Id VARCHAR2(10),
    CONSTRAINT fk_card_customer FOREIGN KEY (Customer_Id) REFERENCES Customer(Cust_Id)
);

CREATE TABLE Loan (
    Loan_No VARCHAR2(15) PRIMARY KEY,
    Loan_Amount NUMBER(15,2) NOT NULL,
    Loan_Type VARCHAR2(50),
    Loan_Duration_Months NUMBER(4),
    Interest_Rate NUMBER(5,2),
    Monthly_Payment_Due_Date DATE,
    Monthly_Minimum_Payment NUMBER(12,2),
    Payment_Method VARCHAR2(30),
    Customer_Id VARCHAR2(10),
    Emp_Id VARCHAR2(10),
    CONSTRAINT fk_loan_customer FOREIGN KEY (Customer_Id) REFERENCES Customer(Cust_Id),
    CONSTRAINT fk_loan_employee FOREIGN KEY (Emp_Id) REFERENCES Employee(Emp_Id)
);

CREATE TABLE Payment (
    Payment_No VARCHAR2(15) PRIMARY KEY,
    Payment_Date DATE NOT NULL,
    Payment_Amount NUMBER(12,2) NOT NULL,
    Loan_No VARCHAR2(15),
    CONSTRAINT fk_payment_loan FOREIGN KEY (Loan_No) REFERENCES Loan(Loan_No)
);


CREATE INDEX idx_customer_name ON Customer(Name);
CREATE INDEX idx_customer_email ON Customer(Email_Id);
CREATE INDEX idx_account_customer ON Account(Customer_Id);
CREATE INDEX idx_loan_customer ON Loan(Customer_Id);
CREATE INDEX idx_payment_loan ON Payment(Loan_No);

CREATE TABLE Account_Audit (
    Audit_Id NUMBER PRIMARY KEY,
    Account_No VARCHAR2(15),
    Operation VARCHAR2(10),
    Old_Balance NUMBER(15,2),
    New_Balance NUMBER(15,2),
    Change_Date TIMESTAMP,
    Changed_By VARCHAR2(50),
    CONSTRAINT fk_audit_account FOREIGN KEY (Account_No) REFERENCES Account(Account_No)
);

CREATE SEQUENCE audit_seq
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

CREATE OR REPLACE TRIGGER account_balance_change
AFTER UPDATE OF Account_Balance ON Account
FOR EACH ROW
BEGIN
    INSERT INTO Account_Audit (
        Audit_Id,
        Account_No,
        Operation,
        Old_Balance,
        New_Balance,
        Change_Date,
        Changed_By
    ) VALUES (
        audit_seq.NEXTVAL,
        :NEW.Account_No,
        'UPDATE',
        :OLD.Account_Balance,
        :NEW.Account_Balance,
        SYSTIMESTAMP,
        USER
    );
END;
/
