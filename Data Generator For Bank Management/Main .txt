import cx_Oracle
import datetime


# Database connection function
def connect_db():
    return cx_Oracle.connect("SYSTEM", "SYSTEM", "localhost:1521/XE")


# Add a new customer
def add_customer(cursor):
    print("\n-- Add New Customer --")
    data = {}
    data['Cust_Id'] = input("Enter Customer ID: ")
    data['First_Name'] = input("Enter First Name: ")
    data['Last_Name'] = input("Enter Last Name: ")
    data['Name'] = input("Enter Full Name: ")

    # Handle date conversion
    while True:
        bd_input = input("Enter Birth Date (YYYY-MM-DD): ")
        try:
            year, month, day = map(int, bd_input.strip().split('-'))
            data['Birth_Date'] = datetime.date(year, month, day)
            break
        except ValueError:
            print("Invalid date format. Please enter in YYYY-MM-DD format.")

    data['Street_Number'] = input("Enter Street Number: ")
    data['Street_Name'] = input("Enter Street Name: ")
    data['Unit'] = input("Enter Unit/Apt: ")
    data['City'] = input("Enter City: ")
    data['State'] = input("Enter State: ")
    data['Zip_Code'] = input("Enter Zip Code: ")
    data['Email_Id'] = input("Enter Email: ")
    data['Social_Security_Number'] = input("Enter Social Security Number: ")
    data['Address'] = input("Enter Full Address: ")
    data['Branch_Code'] = input("Enter Branch Code: ")

    sql = """
    INSERT INTO Customer (
        Cust_Id, First_Name, Last_Name, Name, Birth_Date, Street_Number, Street_Name,
        Unit, City, State, Zip_Code, Email_Id, Social_Security_Number, Address, Branch_Code
    ) VALUES (
        :Cust_Id, :First_Name, :Last_Name, :Name, :Birth_Date, :Street_Number, :Street_Name,
        :Unit, :City, :State, :Zip_Code, :Email_Id, :Social_Security_Number, :Address, :Branch_Code
    )
    """
    cursor.execute(sql, data)
    print("Customer added successfully.")


# Delete a customer
def delete_customer(cursor):
    print("\n-- Delete Customer --")
    cust_id = input("Enter the Customer ID to delete: ")
    cursor.execute("DELETE FROM Customer WHERE Cust_Id = :1", (cust_id,))
    print("Customer deleted (if existed).")


# Update customer info
def update_customer(cursor):
    print("\n-- Update Customer Info --")
    cust_id = input("Enter the Customer ID to update: ")
    field = input("Enter the field to update (e.g. Email_Id): ")
    new_value = input("Enter the new value: ")
    sql = f"UPDATE Customer SET {field} = :1 WHERE Cust_Id = :2"
    cursor.execute(sql, (new_value, cust_id))
    print("Customer updated successfully.")


# Join Customer with Account (simple display example)
def join_customer_account(cursor):
    print("\n-- Customer & Account Info --")
    sql = """
    SELECT c.Cust_Id, c.Name, a.Account_No, a.Account_Balance
    FROM Customer c
    JOIN Account a ON c.Cust_Id = a.Customer_Id
    """
    cursor.execute(sql)
    rows = cursor.fetchall()
    if rows:
        for row in rows:
            print(row)
    else:
        print("No customer-account records found.")


def filter_customers_advanced(cursor):
    print("\n------ Advanced Customer Filter ------")
    print("Choose the criteria to filter by:")
    print("1. City")
    print("2. Name (First Name, Last Name, or Name prefix)")
    print("3. Date of Birth")
    print("4. State")
    print("5. Zip Code")

    choice = input("Enter your choice (1-5): ").strip()

    if choice == "1":  # Filter by City
        city = input("Enter the City: ").strip()
        sql = "SELECT Cust_Id, Name, City FROM Customer WHERE City = :1"
        cursor.execute(sql, (city,))

    elif choice == "2":  # Filter by Name
        name = input("Enter the Name or Name prefix: ").strip()
        # Assuming the user might want to filter by first name, last name, or full name starting with the input.
        sql = """SELECT Cust_Id, First_Name, Last_Name, Name 
                 FROM Customer 
                 WHERE First_Name LIKE :name 
                   OR Last_Name LIKE :name 
                   OR Name LIKE :name"""
        # Append '%' for the prefix match
        cursor.execute(sql, {'name': name + '%'})

    elif choice == "3":  # Filter by Date of Birth
        print("a. Exact Date")
        print("b. Year")
        print("c. Date Range")
        dob_choice = input("Enter your sub-choice (a, b, or c): ").strip().lower()

        if dob_choice == "a":
            dob_input = input("Enter the exact Birth Date (YYYY-MM-DD): ").strip()
            try:
                year, month, day = map(int, dob_input.split('-'))
                dob_date = datetime.date(year, month, day)
            except ValueError:
                print("Invalid date format. Please use YYYY-MM-DD.")
                return
            sql = "SELECT Cust_Id, Name, Birth_Date FROM Customer WHERE Birth_Date = :1"
            cursor.execute(sql, (dob_date,))

        elif dob_choice == "b":
            year_input = input("Enter the Birth Year (YYYY): ").strip()
            try:
                year_int = int(year_input)
            except ValueError:
                print("Invalid year. Please enter a numeric year (YYYY).")
                return
            # Extract the year from the date column
            sql = "SELECT Cust_Id, Name, Birth_Date FROM Customer WHERE EXTRACT(YEAR FROM Birth_Date) = :1"
            cursor.execute(sql, (year_int,))

        elif dob_choice == "c":
            start_input = input("Enter the start date (YYYY-MM-DD): ").strip()
            end_input = input("Enter the end date (YYYY-MM-DD): ").strip()
            try:
                start_year, start_month, start_day = map(int, start_input.split('-'))
                end_year, end_month, end_day = map(int, end_input.split('-'))
                start_date = datetime.date(start_year, start_month, start_day)
                end_date = datetime.date(end_year, end_month, end_day)
            except ValueError:
                print("Invalid date format. Please use YYYY-MM-DD for both dates.")
                return
            sql = "SELECT Cust_Id, Name, Birth_Date FROM Customer WHERE Birth_Date BETWEEN :1 AND :2"
            cursor.execute(sql, (start_date, end_date))
        else:
            print("Invalid choice for Date of Birth filter.")
            return

    elif choice == "4":  # Filter by State
        state = input("Enter the State: ").strip()
        sql = "SELECT Cust_Id, Name, State FROM Customer WHERE State = :1"
        cursor.execute(sql, (state,))

    elif choice == "5":  # Filter by Zip Code
        zipcode = input("Enter the Zip Code: ").strip()
        sql = "SELECT Cust_Id, Name, Zip_Code FROM Customer WHERE Zip_Code = :1"
        cursor.execute(sql, (zipcode,))

    else:
        print("Invalid choice. Please select a valid option (1-5).")
        return

    rows = cursor.fetchall()
    if rows:
        print("\n-- Matching Customers --")
        for row in rows:
            print(row)
    else:
        print("No matching records found.")

# Get single customer info
def check_customer_info(cursor):
    print("\n-- Check Customer Info --")
    cust_id = input("Enter the Customer ID: ")
    cursor.execute("SELECT * FROM Customer WHERE Cust_Id = :1", (cust_id,))
    row = cursor.fetchone()
    if row:
        print(row)
    else:
        print("Customer not found.")


def main_menu():
    print("\n====== Bank Management System ======")
    print("1. Add New Customer")
    print("2. Delete Customer")
    print("3. Update Customer Info")
    print("4. Join Customer with Account")
    print("5. Filter Customers by City")
    print("6. Check Customer Info")
    print("7. Exit")
    choice = input("Enter your choice: ")
    return choice.strip()


if __name__ == "__main__":
    conn = connect_db()
    cursor = conn.cursor()

    try:
        while True:
            choice = main_menu()
            if choice == '1':
                add_customer(cursor)
                conn.commit()
            elif choice == '2':
                delete_customer(cursor)
                conn.commit()
            elif choice == '3':
                update_customer(cursor)
                conn.commit()
            elif choice == '4':
                join_customer_account(cursor)
            elif choice == '5':
                filter_customers_advanced(cursor)
            elif choice == '6':
                check_customer_info(cursor)
            elif choice == '7':
                print("Exiting...")
                break
            else:
                print("Invalid option. Please try again.")
    except cx_Oracle.DatabaseError as e:
        print("Database error:", e)
        conn.rollback()
    except Exception as ex:
        print("Error:", ex)
    finally:
        cursor.close()
        conn.close()
